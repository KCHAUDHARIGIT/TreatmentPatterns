---
title: "Executing a study using the TreatmentPatterns package"
author: "Aniek F Markus"
date: "`r Sys.Date()`"
output: pdf_document # rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette describes how to run a custom treatment patterns study.


# 1. Setting up
Make sure you have TreatmentPatterns installed and all dependencies (see instructions in README).


# 2. Executing the study

If you like to execute the customized study package against a database follow these instructions:

- Download and open the R package using RStudio. 
- Build the package (packages required are listed in DESCRIPTION file).
- Design a study (see vignette "Designing a study using the TreatmentPatterns package).


## 2.1 Databases in OMOP CDM format

### A) Manually filling the inst folder in the package

Full example:
```{r tidy=FALSE,eval=FALSE}
library(TreatmentPatterns)
dataSettings <- createDataSettings(OMOP_CDM = TRUE,
                                   connectionDetails = DatabaseConnector::createConnectionDetails(dbms = Sys.getenv('dbms'),
                                                                                                  server = Sys.getenv('server'),
                                                                                                  user = Sys.getenv('user'),
                                                                                                  password = Sys.getenv('password'),
                                                                                                  port = Sys.getenv('port')),
                                   cdmDatabaseSchema = 'cdm',
                                   cohortDatabaseSchema = 'amarkus',
                                   cohortTable = "treatmentpatterns_cohorts")

cohortSettings <- createCohortSettings(cohortsToCreate_location = file.path(system.file(package = "TreatmentPatterns"),
                                                                            "examples", "OMOP CDM", "inst", "settings", "cohorts_to_create.csv"))

characterizationSettings <- createCharacterizationSettings(baselineCovariates_location = file.path(system.file(package = "TreatmentPatterns"),
                                                                                                   "examples", "OMOP CDM", "inst", "settings", "characterization_settings.csv"))

pathwaySettings <- createPathwaySettings(pathwaySettings_location = file.path(system.file(package = "TreatmentPatterns"),
                                                                              "examples", "OMOP CDM", "inst", "settings", "pathway_settings.csv"))

saveSettings <- createSaveSettings(databaseName = "IPCI")

TreatmentPatterns::executeTreatmentPatterns(dataSettings = dataSettings,
                                            cohortSettings = cohortSettings,
                                            characterizationSettings = characterizationSettings,
                                            pathwaySettings = pathwaySettings,
                                            saveSettings = saveSettings)
```


### B) Using function arguments when calling the main function of the package

Full example:
```{r tidy=FALSE,eval=FALSE}
library(TreatmentPatterns)
dataSettings <- createDataSettings(OMOP_CDM = TRUE,
                                   connectionDetails = DatabaseConnector::createConnectionDetails(dbms = Sys.getenv('dbms'),
                                                                                                  server = Sys.getenv('server'),
                                                                                                  user = Sys.getenv('user'),
                                                                                                  password = Sys.getenv('password'),
                                                                                                  port = Sys.getenv('port')),
                                   cdmDatabaseSchema = 'cdm',
                                   cohortDatabaseSchema = 'amarkus',
                                   cohortTable = "treatmentpatterns_cohorts")

cohortSettings <- createCohortSettings(targetCohorts = data.frame(cohortId = c(1),
                                                                  atlasId = c(590),
                                                                  cohortName = c('Hypertension'),
                                                                  conceptSet = ""),
                                       eventCohorts = data.frame(cohortId = c(10, 11, 12, 13, 14),
                                                                 atlasId = c(1777381,1777382, 1777383, 1777384, 1777385),
                                                                 cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                                                                'Amlodipine', 'Lisinopril', 'Losartan'),
                                                                 conceptSet = c("", "", "", "", "")),
                                       baseUrl = "http://Res-Srv-Lin-01:8080/WebAPI",
                                       loadCohorts = TRUE)

characterizationSetttings <- createCharacterizationSettings(baselineCovariates = data.frame(covariateName = c('Male', 'Age', 
                                                                                                              'Charlson comorbidity index score'),
                                                                                            covariateId = c(8507001, 1002, 1901)))

pathwaySettings <- createPathwaySettings(targetCohortId = 590, eventCohortIds = c(10, 11, 12, 13, 14))

saveSettings <- createSaveSettings(databaseName = "IPCI")

TreatmentPatterns::executeTreatmentPatterns(dataSettings = dataSettings,
                                            cohortSettings = cohortSettings,
                                            characterizationSettings = characterizationSettings,
                                            pathwaySettings = pathwaySettings,
                                            saveSettings = saveSettings)
```


## 2.2 Databases in other formats

### A) Manually filling the inst folder in the package
Full example:
```{r tidy=FALSE,eval=FALSE}
dataSettings <- createDataSettings(OMOP_CDM = FALSE,
                                   cohortLocation = file.path(system.file(package = "TreatmentPatterns"), "examples", "other format", "inst",
                                                              "cohorts", "input_cohorts.csv"))

cohortSettings <- createCohortSettings(cohortsToCreate_location = paste0(system.file(package = "TreatmentPatterns"), "examples", "other format", "inst", "settings", "cohorts_to_create.csv"))

pathwaySettings <- createPathwaySettings(pathwaySettings_location = file.path(system.file(package = "TreatmentPatterns"),
                                                                              "examples", "other format", "inst", "settings", "pathway_settings.csv"))

saveSettings <- createSaveSettings(databaseName = "IPCI")

TreatmentPatterns::executeTreatmentPatterns(dataSettings = dataSettings,
                                            cohortSettings = cohortSettings,
                                            pathwaySettings = pathwaySettings,
                                            saveSettings = saveSettings)
```

### B) Using function arguments when calling the main function of the package
```{r tidy=FALSE,eval=FALSE}
library(TreatmentPatterns)
dataSettings <- createDataSettings(OMOP_CDM = FALSE,
                                   cohortLocation = file.path(system.file(package = "TreatmentPatterns"), "examples", "other format", "inst",
                                                              "cohorts", "input_cohorts.csv"))

cohortSettings <- createCohortSettings(targetCohorts = data.frame(cohortId = c(1),
                                                                  atlasId = c(1777380),
                                                                  cohortName = c('Hypertension'),
                                                                  conceptSet = ""),
                                       eventCohorts = data.frame(cohortId = c(10, 11, 12, 13, 14),
                                                                 atlasId = c(1777381,1777382, 1777383, 1777384, 1777385),
                                                                 cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                                                                'Amlodipine', 'Lisinopril', 'Losartan'),
                                                                 conceptSet = c("", "", "", "", "")))

characterizationSetttings <- createCharacterizationSettings(baselineCovariates = data.frame(covariateName = c('Male', 'Age', 
                                                                                                              'Charlson comorbidity index score'),
                                                                                            covariateId = c(8507001, 1002, 1901)))

pathwaySettings <- createPathwaySettings(targetCohortId = 590, eventCohortIds = c(10, 11, 12, 13, 14))

saveSettings <- createSaveSettings(databaseName = "IPCI")

TreatmentPatterns::executeTreatmentPatterns(dataSettings = dataSettings,
                                            cohortSettings = cohortSettings,
                                            pathwaySettings = pathwaySettings,
                                            saveSettings = saveSettings)
```

# 3. Results

- The results are combined in the autoomatically generated zip file

- Select the folder containing the zip files and run the Shiny App for an interactive visualization of the results:
```{r tidy=FALSE,eval=FALSE}
TreatmentPatterns::launchResultsExplorer(zipFolder)
```

- Share the results in the automatically generated zip folder.

