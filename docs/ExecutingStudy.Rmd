---
title: "Executing a study using the TreatmentPatterns package"
author: "Aniek F Markus"
date: "`r Sys.Date()`"
output: pdf_document # rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette describes how to run a custom treatment patterns study.


# 1. Setting up
Make sure you have TreatmentPatterns installed and all dependencies (see instructions in README).


# 2. Executing the study

If you like to execute the customized study package against a database follow these instructions:

- Download and open the R package using RStudio. 
- Build the package (packages required are listed in DESCRIPTION file).
- Design a study (see vignette "Designing a study using the TreatmentPatterns package).


## 2.1 Databases in OMOP CDM format

3. In extras -> CodeToRun.R: specify connection details (if OMOP-CDM) or cohort location (if Other format). 


### A) Manually filling the inst folder in the package

Full example:
```{r tidy=FALSE,eval=FALSE}
library(TreatmentPatterns)

connectionDetails <- DatabaseConnector::createConnectionDetails(dbms = Sys.getenv('dbms'),
                                                                server = Sys.getenv('server'),
                                                                user = Sys.getenv('user'),
                                                                password = Sys.getenv('password'),
                                                                port = Sys.getenv('port'))


cdmDatabaseSchema <- 'cdm'
cohortDatabaseSchema <- 'results'
databaseName <- 'IPCI'
cohortTable <- 'treatment_patterns'

instFolder <- paste0(system.file(package = "TreatmentPatterns"),"/examples/OMOP CDM/inst")
outputFolder <- paste0(getwd(), "/output")
tempFolder <- paste0(getwd(), "/temp")

TreatmentPatterns::executeTreatmentPatterns(OMOP_CDM = TRUE,
                                            connectionDetails = connectionDetails,
                                            cdmDatabaseSchema = cdmDatabaseSchema,
                                            cohortDatabaseSchema = cohortDatabaseSchema,
                                            databaseName = databaseName,
                                            cohortTable = paste0(cohortTable, "_", databaseName),
                                            instFolder = instFolder,
                                            outputFolder = outputFolder,
                                            tempFolder = tempFolder
                                            )
```

### B) Using function arguments when calling the main function of the package

Full example:
```{r tidy=FALSE,eval=FALSE}
library(TreatmentPatterns)

connectionDetails <- DatabaseConnector::createConnectionDetails(dbms = Sys.getenv('dbms'),
                                                                server = Sys.getenv('server'),
                                                                user = Sys.getenv('user'),
                                                                password = Sys.getenv('password'),
                                                                port = Sys.getenv('port'))

cdmDatabaseSchema <- 'cdm'
cohortDatabaseSchema <- 'results' 
databaseName <- 'IPCI'
cohortTable <- 'treatment_patterns'

rootFolder <- getwd()

targetCohorts <- data.frame(cohortId = c(1),
                           atlasId = c(1777380),
                           cohortName = c('Hypertension'))

eventCohorts <- data.frame(cohortId = c(10, 11, 12, 13, 14),
                          atlasId = c(1777381,1777382, 1777383, 1777384, 1777385),
                          cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                         'Amlodipine', 'Lisinopril', 'Losartan'))

characterizationSettings <- data.frame(covariateName = c('Male', 'Age',
                                                          'Charlson comorbidity index score'),
                                       covariateId = c(8507001, 1002, 1901))

studySettings <- data.frame(studyName = c("default", "analysis1"),
                            targetCohortId = c(1,1),
                            eventCohortIds = c("10,11,12,13,14","10,11,12,13,14"),
                            includeTreatmentsPriorToIndex = c(0,0),
                            minEraDuration = c(0,5),
                            splitEventCohorts = c("",""),
                            eraCollapseSize = c(0,30),
                            combinationWindow = c(30,30), 
                            minStepDuration = c(30,30),
                            filterTreatments = c("First","Changes"),
                            maxPathLength = c(5,5), 
                            minCellCount = c(0,5),
                            minCellMethod = c("Remove","Adjust"),
                            groupCombinations = c(10,10),
                            addNoPaths = c(FALSE, TRUE))   

baseUrl <- "http://atlas-demo.ohdsi.org/WebAPI"

TreatmentPatterns::executeTreatmentPatterns(connectionDetails = connectionDetails,
                                            cdmDatabaseSchema = cdmDatabaseSchema,
                                            cohortDatabaseSchema = cohortDatabaseSchema,
                                            databaseName = databaseName,
                                            cohortTable = paste0(cohortTable, "_", databaseName),
                                            rootFolder = rootFolder,
                                            targetCohorts = targetCohorts,
                                            eventCohorts = eventCohorts,
                                            characterizationSettings = characterizationSettings,
                                            studySettings = studySettings,
                                            loadCohorts = TRUE,
                                            baseUrl = baseUrl)
```

## 2.2 Databases in other formats

### A) Manually filling the inst folder in the package
Full example:
```{r tidy=FALSE,eval=FALSE}
databaseName <- 'IPCI'

instFolder <- paste0(system.file(package = "TreatmentPatterns"),"/examples/other format/inst")
outputFolder <- paste0(getwd(), "/output")
tempFolder <- paste0(getwd(), "/temp")

cohortLocation <- paste0(instFolder, "/cohorts/input_cohorts.csv")

TreatmentPatterns::executeTreatmentPatterns(OMOP_CDM = FALSE,
                                            databaseName = databaseName,
                                            instFolder = instFolder,
                                            outputFolder = outputFolder,
                                            tempFolder = tempFolder,
                                            cohortLocation = cohortLocation,
                                            runCohortCharacterization = FALSE)
```

### B) Using function arguments when calling the main function of the package
```{r tidy=FALSE,eval=FALSE}
databaseName <- 'IPCI'

rootFolder <- getwd()

cohortLocation <- paste0(system.file(package = "TreatmentPatterns"),"/examples/other format/inst/cohorts/input_cohorts.csv")

targetCohorts <- data.frame(cohortId = c(1),
                           atlasId = c(""),
                           cohortName = c('Hypertension'))

eventCohorts <- data.frame(cohortId = c(10, 11, 12, 13, 14),
                          atlasId = c("","", "", "", ""),
                          cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                         'Amlodipine', 'Lisinopril', 'Losartan'))

studySettings <- data.frame(studyName = c("default", "analysis1"),
                            targetCohortId = c(1,1),
                            eventCohortIds = c("10,11,12,13,14","10,11,12,13,14"),
                            includeTreatmentsPriorToIndex = c(0,0),
                            minEraDuration = c(0,5),
                            splitEventCohorts = c("",""),
                            eraCollapseSize = c(0,30),
                            combinationWindow = c(30,30), 
                            minStepDuration = c(30,30),
                            filterTreatments = c("First","Changes"),
                            maxPathLength = c(5,5), 
                            minCellCount = c(0,5),
                            minCellMethod = c("Remove","Adjust"),
                            groupCombinations = c(10,10),
                            addNoPaths = c(FALSE, TRUE))   

TreatmentPatterns::executeTreatmentPatterns(OMOP_CDM = FALSE,
                                            databaseName = databaseName,
                                            rootFolder = rootFolder,
                                            cohortLocation = cohortLocation,
                                            targetCohorts = targetCohorts,
                                            eventCohorts = eventCohorts,
                                            studySettings = studySettings,
                                            runCohortCharacterization = FALSE)
```

# 3. Results

- The results are combined in the autoomatically generated zip file

- Select the folder containing the zip files as 'rootFolder' and run the Shiny App for an interactive visualization of the results:
```{r tidy=FALSE,eval=FALSE}
TreatmentPatterns::launchShinyApplication(rootFolder)
```

- Share the results in the automatically generated zip folder.

