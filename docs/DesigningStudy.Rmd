---
title: "Designing a study using the TreatmentPatterns package"
author: "Aniek F Markus"
date: "`r Sys.Date()`"
output: pdf_document # rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette describes how to design a custom treatment patterns study (TODO: needs to be updated!)

# 1. Setting up
Make sure you have TreatmentPatterns installed and all dependencies (see instructions in README).

# 2. Designing the study
There are two approaches: A) manually filling the inst folder in the package or B) by using function arguments when calling the main function of the package. We first describe both approaches for databases in OMOP CDM format (2.1) and then for other data formats (2.2). 

Throughout this vignette we will use an adjusted example describing the treatment patterns of hypertension patients. The included drugs of interests are hydrochlorothiazide, metorolol, amlodipine, lisinopril, and losartan (for simplicity we limit it to 5 events of interest).

Some definitions used throughout this vignette:

- Target cohort = study population.

- Event cohort(s) = treatment(s) of interest.

## 2.1 Databases in OMOP CDM format

### A) Manually filling the inst folder in the package

1. Define target/event cohorts.
- Specify all cohorts in ATLAS. When defining the target cohort note that it might be desirable to request a minimum follow up time after cohort entry / the index date to have sufficient information on treatment history.
- Download the SQL and JSON files and add to folder inst/cohorts/SQL and inst/cohorts/JSON.

- Then specify the target/event cohorts in inst/settings/cohorts_to_create.csv:
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Unique ID number","Descriptive name cohort","‘ATLAS’ or ‘Custom’ (see explanation in Section 3.1)", "‘target’ or ‘event’", "Cohort ID ATLAS")
colnames(table) <- c("cohortId", "cohortName", "cohortDefinition", "cohortType", "atlasID")
kable(table)
```
2. Optional: specify baseline characteristics of interest.

```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Descriptive name covariate", "Unique ID number referring to covariate from FeatureExtraction or 'Custom' (see explanation in Section 3.2)")
colnames(table) <- c("covariateName", "covariateId")
kable(table)
```

3. Define pathway settings.

A default list of pathway settings: 
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame(c("studyName", "targetCohortId", "eventCohortIds", "includeTreatmentsPriorToIndex", "minEraDuration","splitEventCohorts","eraCollapseSize", "combinationWindow","minStepDuration","filterTreatments","maxPathLength","minCellCount", "minCellMethod","groupCombinations","addNoPaths"),c("default","1",'"10,11,12,13,14"',"0", "0","","0","30","30","First","5","0","Remove","10","FALSE"),
                    c("Unique name identifying the set of study parameters below", "Select one study population", "Select all treatments of interest", "Number of days prior to the index date of the target cohort that event cohorts are allowed to start", "Minimum time an event era should last to be included in analysis", "Specify event cohort to split in acute (< 30 days) and therapy (>= 30 days)", "Window of time between which two eras of the same event cohort are collapsed into one era", "Window of time two event cohorts need to overlap to be considered a combination treatment", "Minimum time an event era before or after a generated combination treatment should last to be included in analysis", "Select first occurrences of / changes between / all event cohorts", "Maximum number of steps included in treatment pathway", "Minimum number of persons with a specific treatment pathway for the pathway to be included in analysis", "Select to completely remove / sequentially adjust (by removing last step as often as necessary) treatment pathways below minCellCount", "Select to group all non-fixed combinations in one category 'other’ in the sunburst plot", "Select to include untreated persons without treatment pathway in the sunburst plot"))
colnames(table) <- c("param", "values", "description")
kable(table)
```

Change these parameters according to the needs of your study in inst/Settings/pathway_settings.csv.


### B) Using function arguments when calling the main function of the package

We need the following components:

1. Define target/event cohorts.

- Specify all cohorts in ATLAS. When defining the target cohort note that it might be desirable to request a minimum follow up time after cohort entry / the index date to have sufficient information on treatment history.

- The study population of interest (target cohorts).

```{r tidy=FALSE,eval=FALSE}
targetCohorts <- data.frame(cohortId = c(1),
                            cohortName = c('Hypertension'),
                            atlasId = c(1777380),
                            conceptSet = c("")) # conceptSet can also be left out
```

- The events of interest (event cohorts).

```{r tidy=FALSE,eval=FALSE}
eventCohorts <- data.frame(cohortId = c(10, 11, 12, 13, 14),
                           cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                          'Amlodipine', 'Lisinopril', 'Losartan'),
                           atlasId = c(1777381,1777382, 1777383, 1777384, 1777385),
                           conceptSet = c("","","","","")) # conceptSet can also be left out
```

2. Optional: specify baseline characteristics of interest.

```{r tidy=FALSE,eval=FALSE}
characterizationSettings <- data.frame(covariateName = c('Male', 'Age',
                                                          'Charlson comorbidity index score'),
                                       covariateId = c(8507001, 1002, 1901))
```

3. Define pathway settings.

```{r tidy=FALSE,eval=FALSE}
pathwaySettings <- data.frame(studyName = c("default", "analysis1"),
                            targetCohortId = c(1,1),
                            eventCohortIds = c("10,11,12,13,14","10,11,12,13,14"),
                            includeTreatmentsPriorToIndex = c(0,0),
                            minEraDuration = c(0,5),
                            splitEventCohorts = c("",""),
                            eraCollapseSize = c(0,30),
                            combinationWindow = c(30,30), 
                            minStepDuration = c(30,30),
                            filterTreatments = c("First","Changes"),
                            maxPathLength = c(5,5), 
                            minCellCount = c(0,5),
                            minCellMethod = c("Remove","Adjust"),
                            groupCombinations = c(10,10),
                            addNoPaths = c(FALSE, TRUE))                                       
```


## 2.2 Databases in other formats

### A) Manually filling the inst folder in the package

1. Define target/event cohorts and add to package.

- Import the target/event cohorts from a csv file into the package. Add cohorts in inst/cohorts/input_cohorts.csv:
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Unique ID number","Unique person ID number","Entry date cohort", "Exit date cohort")
colnames(table) <- c("cohortId", "personId", "startDate", "endDate")
kable(table)
```

- Then specify the target/event cohorts in inst/settings/cohorts_to_create.csv:
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Unique ID number","Descriptive name cohort","‘ATLAS’ or ‘Custom’ (see explanation in Section 3.1)", "‘target’ or ‘event’", "Cohort ID ATLAS")
colnames(table) <- c("cohortId", "cohortName", "cohortDefinition", "cohortType", "atlasID")
kable(table)
```

2. Define pathway settings.

See explanation in Section 2.1 (A).


### B) Using function arguments when calling the main function of the package


1. Define target/event cohorts and add to package.

- Import the target/event cohorts from a csv file into the package. Add cohorts in inst/cohorts/input_cohorts.csv:
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Unique ID number","Unique person ID number","Entry date cohort", "Exit date cohort")
colnames(table) <- c("cohortId", "personId", "startDate", "endDate")
kable(table)
```

- The study population of interest (target cohorts).

```{r tidy=FALSE,eval=FALSE}
targetCohorts <- data.frame(cohortId = c(1),
                            atlasId = c(""),
                            cohortName = c('Hypertension'))
```

- The events of interest (event cohorts).

```{r tidy=FALSE,eval=FALSE}
eventCohorts <- data.frame(cohortId = c(10, 11, 12, 13, 14),
                           atlasId = c("","", "", "", ""),
                           cohortName = c('Hydrochlorothiazide', 'Metorolol',
                                          'Amlodipine', 'Lisinopril', 'Losartan'))
```

2. Define pathway settings.

See explanation in Section 2.1 (B).



# 3. Extra options

## 3.1 Custom cohorts using concept set and template

Instead of defining each cohort separately in ATLAS, there is the possibility to specify a file with concept sets that will be used in combination with a SQL template. In the package there is a cohort template available for drugs (inst/SQL/CohortDrugTemplate.sql). This template identifies all drug exposures of the concept set till the end of a continuous exposure with a maximum persistence window of 30 days. If you want to make use of this option, you need to fill the inst folder manually (approach A). 


- Alternatively, specify a concept set and create re-use or create a new inst/SQL/CohortDrugTemplate.sql. Specify concept sets in instFolder/settings/eventcohorts_custom.csv:
```{r, fig.show='hold', echo=FALSE}
library('knitr')
table <- data.frame("Descriptive name cohort","Number of concept IDs in conceptSet","List of unique concept IDs to be included")
colnames(table) <- c("cohortName","count","conceptSet")
kable(table)
```

## 3.2 Adding custom covariates for baseline characterization

If desired, one can add custom covariates in inst/SQL for characterization. An example template: 

```{r tidy=FALSE,eval=FALSE}
SELECT @covariateId AS covariate_id,
{@aggregated} ? {
  cohort_definition_id,
  COUNT(DISTINCT target.@rowIdField) AS sum_value
} : {
  target.@rowIdField  AS row_id,
  1 AS covariate_value
}
FROM @cohortTable target
INNER JOIN @cdmDatabaseSchema.condition_occurrence covariate
ON covariate.person_id = target.@rowIdField 
WHERE covariate.condition_concept_id IN ()
AND covariate.condition_start_date <= target.cohort_start_date
{@cohortId != -1} ? {AND cohort_definition_id IN (@cohortId)}
{@aggregated} ? {GROUP BY cohort_definition_id}
```

## 3.3 Stand alone sunburst plot functionality

```{r tidy=FALSE,eval=FALSE}
data <- readr::read_csv(paste0(system.file(package = "TreatmentPatterns"),"/examples/sequences.csv"),
                        col_types = list("c", "i"))
createSunburstPlot(data, folder = outputFolder <- paste0(getwd(), "/output"),
                   file_name = "example", shiny = FALSE,
                   title = "example sequences.csv")
```

## 3.4 Add custom analysis parts

If desired, one can add additional output functions. Need to add R code and adjust shiny application.

